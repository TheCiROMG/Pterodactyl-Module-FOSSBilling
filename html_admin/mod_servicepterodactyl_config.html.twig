{% import 'macro_functions.html.twig' as mf %}
    <div class="card-body">
        <h1>{{ 'Pterodactyl Panel Configuration'|trans }}</h1>
        <form method="post" action="{{ 'api/admin/product/update_config'|link }}" class="api-form save" data-api-msg="{{ 'Pterodactyl settings updated'|trans }}">
            <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}"/>
            
            <h2>{{ 'Deployment Settings'|trans }}</h2>
            
            {# Fetch data from Pterodactyl #}
            {% set locations = admin.servicepterodactyl_get_locations() %}
            {% set all_nodes = admin.servicepterodactyl_get_nodes() %}
            {% set eggs = admin.servicepterodactyl_get_eggs() %}
            {% set settings = admin.servicepterodactyl_get_settings() %}

            {# Filter nodes based on allowed list #}
            {% set nodes = all_nodes %}
            {% if settings.allowed_nodes is defined and settings.allowed_nodes is iterable and settings.allowed_nodes|length > 0 %}
                {% set filtered_nodes = [] %}
                {% for node in all_nodes %}
                    {% if node.id in settings.allowed_nodes %}
                        {% set filtered_nodes = filtered_nodes|merge([node]) %}
                    {% endif %}
                {% endfor %}
                {% set nodes = filtered_nodes %}
            {% endif %}

            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Deployment Type'|trans }}:</label>
                <div class="col">
                    <select class="form-select" id="deployment_type_selector" onchange="toggleDeploymentType()">
                        <option value="node" {% if not product.config.location_id %}selected{% endif %}>{{ 'Specific Node'|trans }}</option>
                        <option value="location" {% if product.config.location_id %}selected{% endif %}>{{ 'Location (Auto-Selection)'|trans }}</option>
                    </select>
                </div>
            </div>

            <div class="mb-3 row" id="node_selector_group" {% if product.config.location_id %}style="display:none;"{% endif %}>
                <label class="form-label col-3 col-form-label">{{ 'Specific Node(s)'|trans }}:</label>
                <div class="col">
                    {% if nodes %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="config[node_selection_mode]" value="single" id="node_mode_single" {% if not product.config.node_selection_mode or product.config.node_selection_mode == 'single' %}checked{% endif %} onchange="toggleNodeSelectionMode()">
                            <label class="form-check-label" for="node_mode_single">{{ 'Single Node (Forced)'|trans }}</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="config[node_selection_mode]" value="client" id="node_mode_client" {% if product.config.node_selection_mode == 'client' %}checked{% endif %} onchange="toggleNodeSelectionMode()">
                            <label class="form-check-label" for="node_mode_client">{{ 'Client Selection (User chooses from list)'|trans }}</label>
                        </div>

                        <div id="single_node_select" {% if product.config.node_selection_mode == 'client' %}style="display:none;"{% endif %}>
                            <select class="form-select" name="config[node_id]">
                                {% for node in nodes %}
                                <option value="{{ node.id }}" {% if product.config.node_id == node.id %}selected{% endif %}>{{ node.name }} (ID: {{ node.id }})</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">{{ 'Server will be created on this specific node.'|trans }}</div>
                        </div>

                        <div id="client_node_select" {% if not product.config.node_selection_mode or product.config.node_selection_mode == 'single' %}style="display:none;"{% endif %}>
                            {% for node in nodes %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="config[selectable_nodes][]" value="{{ node.id }}" id="selectable_node_{{ node.id }}" {% if node.id in product.config.selectable_nodes %}checked{% endif %}>
                                    <label class="form-check-label" for="selectable_node_{{ node.id }}">
                                        {{ node.name }} (ID: {{ node.id }})
                                    </label>
                                </div>
                            {% endfor %}
                            <div class="form-text">{{ 'Select the nodes that the client can choose from during checkout.'|trans }}</div>
                        </div>
                    {% else %}
                        <input type="number" class="form-control" name="config[node_id]" value="{{ product.config.node_id|default(1) }}">
                        <div class="form-text text-danger">{{ 'Could not fetch nodes from API. Please enter ID manually.'|trans }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="mb-3 row" id="location_selector_group" {% if not product.config.location_id %}style="display:none;"{% endif %}>
                <label class="form-label col-3 col-form-label">{{ 'Location'|trans }}:</label>
                <div class="col">
                    {% if locations %}
                    <select class="form-select" name="config[location_id]">
                        <option value="">{{ 'Select Location'|trans }}</option>
                        {% for location in locations %}
                        <option value="{{ location.id }}" {% if product.config.location_id == location.id %}selected{% endif %}>{{ location.short }} - {{ location.long }} (ID: {{ location.id }})</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">{{ 'Servers will be automatically placed on a node in this location.'|trans }}</div>
                    {% else %}
                    <input type="number" class="form-control" name="config[location_id]" value="{{ product.config.location_id }}">
                    <div class="form-text text-danger">{{ 'Could not fetch locations from API. Please enter ID manually.'|trans }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Egg'|trans }}:</label>
                <div class="col">
                    {% if eggs %}
                    <select class="form-select" name="config[egg_id]">
                        <option value="">{{ 'Select Egg'|trans }}</option>
                        {% set current_nest = "init_null_value" %}
                        {% for egg in eggs %}
                            {% if current_nest != egg.nest_name %}
                                {% if current_nest != "init_null_value" %}
                                    </optgroup>
                                {% endif %}
                                <optgroup label="{{ egg.nest_name }}">
                                {% set current_nest = egg.nest_name %}
                            {% endif %}
                            <option value="{{ egg.id }}" {% if product.config.egg_id == egg.id %}selected{% endif %}>
                                {{ egg.name }} (ID: {{ egg.id }})
                            </option>
                        {% endfor %}
                        {% if current_nest != "init_null_value" %}
                            </optgroup>
                        {% endif %}
                    </select>
                    {% else %}
                    <input type="number" class="form-control" name="config[egg_id]" value="{{ product.config.egg_id|default(1) }}">
                    <div class="form-text text-danger">{{ 'Could not fetch eggs from API. Please enter ID manually.'|trans }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Auto Port Allocation removed (handled via variable "AUTO_PORT") -->
            <input type="hidden" name="config[auto_port]" value="0">

            <script>
            function toggleDeploymentType() {
                var type = document.getElementById('deployment_type_selector').value;
                if (type === 'node') {
                    document.getElementById('node_selector_group').style.display = 'flex';
                    document.getElementById('location_selector_group').style.display = 'none';
                    // Clear location input when node is selected to ensure backend uses node logic
                    document.querySelector('select[name="config[location_id]"]').value = '';
                } else {
                    document.getElementById('node_selector_group').style.display = 'none';
                    document.getElementById('location_selector_group').style.display = 'flex';
                    // Clear node input when location is selected
                     // Note: We don't strictly clear it because backend prioritizes location_id check, but good for UI consistency
                }
            }

            function toggleNodeSelectionMode() {
                var isClientMode = document.getElementById('node_mode_client').checked;
                if (isClientMode) {
                    document.getElementById('single_node_select').style.display = 'none';
                    document.getElementById('client_node_select').style.display = 'block';
                } else {
                    document.getElementById('single_node_select').style.display = 'block';
                    document.getElementById('client_node_select').style.display = 'none';
                }
            }
            </script>

            <hr>

            <h2>{{ 'Resource Limits'|trans }}</h2>
            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Memory (MB)'|trans }}:</label>
                <div class="col">
                    <input type="number" class="form-control" name="config[memory]" value="{{ product.config.memory|default(512) }}">
                </div>
            </div>
            
            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Swap (MB)'|trans }}:</label>
                <div class="col">
                    <input type="number" class="form-control" name="config[swap]" value="{{ product.config.swap|default(0) }}">
                </div>
            </div>
            
            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Disk (MB)'|trans }}:</label>
                <div class="col">
                    <input type="number" class="form-control" name="config[disk]" value="{{ product.config.disk|default(1024) }}">
                </div>
            </div>
            
            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'CPU (%)'|trans }}:</label>
                <div class="col">
                    <input type="number" class="form-control" name="config[cpu]" value="{{ product.config.cpu|default(100) }}">
                </div>
            </div>
            
            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'I/O Weight'|trans }}:</label>
                <div class="col">
                    <input type="number" class="form-control" name="config[io]" value="{{ product.config.io|default(500) }}">
                </div>
            </div>

            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'CPU Pinning (Threads)'|trans }}:</label>
                <div class="col">
                    <input type="text" class="form-control" name="config[cpu_pinning]" value="{{ product.config.cpu_pinning }}" placeholder="e.g. 0, 0-1,3">
                    <div class="form-text">{{ 'Advanced: Enter specific CPU threads to allow.'|trans }}</div>
                </div>
            </div>

            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'OOM Disabled'|trans }}:</label>
                <div class="col">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="config[oom_disabled]" value="1" id="oom_disabled" {% if product.config.oom_disabled %}checked{% endif %}>
                        <label class="form-check-label" for="oom_disabled">{{ 'Disable OOM Killer'|trans }}</label>
                    </div>
                </div>
            </div>

            <hr>

            <h2>{{ 'Docker & Startup'|trans }}</h2>
            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Docker Image'|trans }}:</label>
                <div class="col">
                    <input type="text" class="form-control" name="config[docker_image]" value="{{ product.config.docker_image }}" placeholder="{{ 'Leave empty to use Egg default'|trans }}">
                </div>
            </div>

            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Startup Command'|trans }}:</label>
                <div class="col">
                    <textarea class="form-control" name="config[startup_command]" rows="2" placeholder="{{ 'Leave empty to use Egg default'|trans }}">{{ product.config.startup_command }}</textarea>
                </div>
            </div>

            <div id="egg_variables_container">
                <!-- Egg variables will be loaded here -->
            </div>
            
            <hr>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const eggSelect = document.querySelector('select[name="config[egg_id]"]');
                    if (eggSelect) {
                        eggSelect.addEventListener('change', loadEggVariables);
                        // Load initially if egg is selected
                        if (eggSelect.value) {
                            loadEggVariables();
                        }
                    }
                });

                function loadEggVariables(event) {
                    const isChange = (event && event.type === 'change');
                    const eggId = document.querySelector('select[name="config[egg_id]"]').value;
                    const container = document.getElementById('egg_variables_container');
                    
                    if (!eggId) {
                        container.innerHTML = '';
                        return;
                    }

                    container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><br/>{{ "Loading Egg variables..."|trans }}</div>';

                    API.admin.post('servicepterodactyl/get_egg_details', { egg_id: eggId }, function(response) {
                        container.innerHTML = '<h3>{{ "Egg Variables"|trans }}</h3>';
                        
                        // Update Docker Image & Startup Command
                        if (response) {
                            // Docker Images
                            const dockerInput = document.querySelector('input[name="config[docker_image]"]');
                            const dockerContainer = dockerInput.parentNode;
                            
                            // Remove existing helper if any
                            const existingHelper = document.getElementById('docker_images_helper');
                            if (existingHelper) existingHelper.remove();

                            if (response.docker_images) {
                                let dockerHtml = '<div id="docker_images_helper" class="mt-2"><small>{{ "Available Images from Egg:"|trans }}</small><select class="form-select form-select-sm mt-1" onchange="document.querySelector(\'input[name=\\\'config[docker_image]\\\']\').value = this.value">';
                                dockerHtml += '<option value="">{{ "Select an image..."|trans }}</option>';
                                
                                for (const [name, image] of Object.entries(response.docker_images)) {
                                    dockerHtml += `<option value="${image}">${name} (${image})</option>`;
                                }
                                dockerHtml += '</select></div>';
                                dockerContainer.insertAdjacentHTML('beforeend', dockerHtml);
                            }
                            
                            if (response.docker_image) {
                                dockerInput.placeholder = response.docker_image;
                                if (isChange) {
                                    dockerInput.value = '';
                                }
                            }

                            // Startup Command
                            const startupInput = document.querySelector('textarea[name="config[startup_command]"]');
                            if (startupInput) {
                                if (response.startup) {
                                    startupInput.placeholder = response.startup;
                                    if (isChange) {
                                        startupInput.value = '';
                                    }
                                }
                            }
                        }

                        if (response && response.relationships && response.relationships.variables && response.relationships.variables.data) {
                            const variables = response.relationships.variables.data;
                            
                            if (variables.length === 0) {
                                container.innerHTML += '<div class="alert alert-info">{{ "No variables found for this Egg."|trans }}</div>';
                                return;
                            }

                            // Prepare current values from product config
                            const currentConfig = {{ product.config.variables|json_encode|raw }}; // This might be null or undefined initially
                            const currentVisible = {{ product.config.variables_visible|json_encode|raw }};

                            variables.forEach(function(item) {
                                const v = item.attributes;
                                const env = v.env_variable;
                                const fieldName = `config[variables][${env}]`;
                                
                                // Try to find saved value, else default
                                let value = v.default_value;
                                if (currentConfig && currentConfig[env] !== undefined) {
                                    value = currentConfig[env];
                                }
                                
                                let inputHtml = '';
                                const description = v.description ? `<div class="form-text">${v.description}</div>` : '';
                                const required = v.rules.includes('required') ? 'required' : '';
                                
                                inputHtml = `
                                    <div class="mb-3 row">
                                        <label class="form-label col-3 col-form-label">${v.name} (${env}):</label>
                                        <div class="col">
                                            <div class="input-group">
                                                <input type="text" class="form-control" name="${fieldName}" value="${value}" ${required} placeholder="${v.default_value}">
                                            </div>
                                            <div class="form-text text-muted">Use <code>AUTO_PORT</code> for automatic port assignment or <code>AUTO_PASSWORD</code> to generate a random password.</div>
                                            ${description}
                                        </div>
                                    </div>
                                `;
                                container.insertAdjacentHTML('beforeend', inputHtml);
                            });
                        } else {
                            container.innerHTML += '<div class="alert alert-warning">{{ "Could not load variables."|trans }}</div>';
                        }
                    }, function(error) {
                        console.error(error);
                        container.innerHTML = '<div class="alert alert-danger">{{ "Error loading variables."|trans }}</div>';
                    });
                }
            </script>


            <hr>

            <h2>{{ 'Feature Limits'|trans }}</h2>
            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Server Name Pattern'|trans }}:</label>
                <div class="col">
                    <input type="text" class="form-control" name="config[server_name_pattern]" value="{{ product.config.server_name_pattern }}" placeholder="{{ '{{ product.title }} - {{ client.first_name }}'|trans }}">
                    <div class="form-text">{{ 'Variables: {{ client.id }}, {{ client.first_name }}, {{ client.last_name }}, {{ service.id }}, {{ date }}'|trans }}</div>
                </div>
            </div>
            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Server Description'|trans }}:</label>
                <div class="col">
                    <input type="text" class="form-control" name="config[server_description]" value="{{ product.config.server_description }}" placeholder="{{ 'Hosted by FOSSBilling'|trans }}">
                </div>
            </div>
            
            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Dedicated IP'|trans }}:</label>
                <div class="col">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="config[dedicated_ip]" value="1" id="dedicated_ip" {% if product.config.dedicated_ip %}checked{% endif %}>
                        <label class="form-check-label" for="dedicated_ip">{{ 'Try to allocate default port (e.g. 25565) or specific IP'|trans }}</label>
                    </div>
                </div>
            </div>

            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Allocations'|trans }}:</label>
                <div class="col">
                    <input type="number" class="form-control" name="config[allocations]" value="{{ product.config.allocations|default(0) }}">
                    <div class="form-text">{{ 'Number of additional ports allowed (0 for none)'|trans }}</div>
                </div>
            </div>

            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Backups'|trans }}:</label>
                <div class="col">
                    <input type="number" class="form-control" name="config[backups]" value="{{ product.config.backups|default(0) }}">
                    <div class="form-text">{{ 'Number of backups allowed (0 for none)'|trans }}</div>
                </div>
            </div>

            <div class="mb-3 row">
                <label class="form-label col-3 col-form-label">{{ 'Databases'|trans }}:</label>
                <div class="col">
                    <input type="number" class="form-control" name="config[databases]" value="{{ product.config.databases|default(0) }}">
                    <div class="form-text">{{ 'Number of databases allowed (0 for none)'|trans }}</div>
                </div>
            </div>

            <input type="hidden" name="id" value="{{ product.id }}">
            <button class="btn btn-primary w-100" type="submit">{{ 'Update'|trans }}</button>
        </form>
    </div>
